<?php

/**
 * @file
 * DPL Paragraphs tweaks.
 */

use Drupal\Core\Url;
use Drupal\paragraphs\Entity\Paragraph;
use function Safe\parse_url;
use function Safe\preg_match;

/**
 * Implements hook_preprocess_HOOK() for paragraph templates.
 *
 * Add the base icon path to the variables array for use in paragraphs.
 */
function dpl_paragraphs_preprocess_paragraph(array &$variables): void {
  $baseIconPath = $variables['directory'] . '/assets/dpl-design-system/icons';
  $variables['baseIconPath'] = $baseIconPath;
}

/**
 * Implements hook_preprocess_paragraph__TYPE() for paragraph--links.html.twig.
 *
 * Prepares variables for paragraph--links.html.twig template.
 */
function dpl_paragraphs_preprocess_paragraph__links(array &$variables): void {

  $url_generator = \Drupal::service('url_generator');

  // To infer if a link is downloadable with we have a basic approach, with
  // various limitations. It's important to know, that internal files in
  // project, will be uploaded through the media library using a seperate
  // paragraph. As such the check here is primarily for external links to
  // downloadable files. The approach here checks the URL's file extension to
  // determine if it's a downloadable file. The fallback of an external file
  // not being recognized as downloadable, is to treat it as an external link.
  // Limitations include:
  // 1. URLs endings does not guarantee the content is downloadable.
  // 2. Some downloadable content may not have a typical file extension.
  // 3. Does not consider server responses that dictates downloadability.
  $downloadable_file_extensions = 'pdf|docx|txt|png|jpg|jpeg|gif|csv|xls|xlsx|ppt|pptx';

  // Generate base paths for predefined routes (search and advanced search).
  $search_base_path = $url_generator->generateFromRoute('dpl_react_apps.search_result', [], ['absolute' => FALSE]);
  $advanced_search_base_path = $url_generator->generateFromRoute('dpl_react_apps.advanced_search', [], ['absolute' => FALSE]);

  /** @var \Drupal\paragraphs\ParagraphInterface $paragraph */
  $paragraph = $variables['paragraph'];

  if ($paragraph->hasField('field_link') && !$paragraph->get('field_link')->isEmpty()) {

    $items = $paragraph->get('field_link')->getValue();
    $variables['links'] = [];

    foreach ($items as $item) {

      $url = Url::fromUri($item['uri']);

      // Get the normalized path. If null, default to an empty string.
      $parsed_url = parse_url($url->toString(), PHP_URL_PATH);
      $normalized_path = is_null($parsed_url) ? '' : rtrim($parsed_url, '/');

      $link_type = 'internal';

      if ($url->isExternal()) {
        if (preg_match('/\.(' . $downloadable_file_extensions . ')(\?.*)?$/i', $normalized_path)) {
          $link_type = 'download';
        }
        else {
          $link_type = 'external';
        }
      }
      elseif ($normalized_path === $search_base_path || $normalized_path === $advanced_search_base_path) {
        $link_type = 'search';
      }

      $linkIconClass = ($link_type === 'internal') ? 'link-with-icon__icon--rotate-180' : '';

      $attributes = [
        'internal' => ['target' => '_self', 'iconFile' => 'ArrowBack', 'iconFolder' => 'collection'],
        'external' => ['target' => '_blank', 'iconFile' => 'icon-external-link', 'iconFolder' => 'basic'],
        'download' => ['target' => '_blank', 'iconFile' => 'Ebook', 'iconFolder' => 'collection'],
        'search' => ['target' => '_self', 'iconFile' => 'SearchBooks', 'iconFolder' => 'collection'],
      ][$link_type];

      $variables['links'][] = [
        'href' => $url->toString(),
        'linkText' => $item['title'],
        'linkType' => $link_type,
        'target' => $attributes['target'],
        'iconFile' => $attributes['iconFile'],
        'iconFolder' => $attributes['iconFolder'],
        'linkIconClass' => $linkIconClass,
      ];
    }
  }
}

/**
 * Implements theme_preprocess_paragraph__NAME().
 *
 * On the 'medias' paragraph, a possible second image should have a different
 * image-style. We do this, by setting a different view mode on the paragraph.
 */
function dpl_paragraphs_preprocess_paragraph__medias(array &$variables): void {
  $paragraph = $variables['paragraph'] ?? NULL;
  $view_mode = $variables['view_mode'] ?? NULL;

  if ($view_mode === 'preview' ||
      !($paragraph instanceof Paragraph) ||
      (empty($variables['content']['field_medias'][1])) ||
      (!$paragraph->hasField('field_medias'))) {
    return;
  }

  $alternative_images = $paragraph->get('field_medias')->view('alternative');
  $variables['content']['field_medias'][1] = $alternative_images[1] ?? NULL;
}

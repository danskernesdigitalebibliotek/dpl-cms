<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="926px" preserveAspectRatio="none" style="width:1213px;height:926px;background:#FFFFFF;" version="1.1" viewBox="0 0 1213 926" width="1213px" zoomAndPan="magnify"><defs><filter height="300%" id="fa70qh5weubk7" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FFFFFF" filter="url(#fa70qh5weubk7)" height="128.0977" style="stroke:#A80036;stroke-width:1.0;" width="10" x="214" y="247.5273"/><rect fill="#FFFFFF" filter="url(#fa70qh5weubk7)" height="87.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="760" y="463.0234"/><rect fill="#FFFFFF" filter="url(#fa70qh5weubk7)" height="101.6641" style="stroke:#000000;stroke-width:2.0;" width="749.5" x="84" y="565.4219"/><rect fill="#FFFFFF" filter="url(#fa70qh5weubk7)" height="56.2656" style="stroke:#000000;stroke-width:2.0;" width="609.5" x="224" y="681.0859"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="219" x2="219" y1="88.2969" y2="841.75"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="446" x2="446" y1="88.2969" y2="841.75"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="764.5" x2="764.5" y1="88.2969" y2="841.75"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1063.5" x2="1063.5" y1="88.2969" y2="841.75"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="30" x="201" y="84.9951">User</text><ellipse cx="219" cy="15" fill="#FEFECE" filter="url(#fa70qh5weubk7)" rx="8" ry="8" style="stroke:#A80036;stroke-width:2.0;"/><path d="M219,23 L219,50 M206,31 L232,31 M219,50 L206,65 M219,50 L232,65 " fill="none" filter="url(#fa70qh5weubk7)" style="stroke:#A80036;stroke-width:2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="30" x="201" y="853.7451">User</text><ellipse cx="219" cy="867.0469" fill="#FEFECE" filter="url(#fa70qh5weubk7)" rx="8" ry="8" style="stroke:#A80036;stroke-width:2.0;"/><path d="M219,875.0469 L219,902.0469 M206,883.0469 L232,883.0469 M219,902.0469 L206,917.0469 M219,902.0469 L232,917.0469 " fill="none" filter="url(#fa70qh5weubk7)" style="stroke:#A80036;stroke-width:2.0;"/><rect fill="#FEFECE" filter="url(#fa70qh5weubk7)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="72" x="408" y="53"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="58" x="415" y="72.9951">DPL_CMS</text><rect fill="#FEFECE" filter="url(#fa70qh5weubk7)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="72" x="408" y="840.75"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="58" x="415" y="860.7451">DPL_CMS</text><rect fill="#FEFECE" filter="url(#fa70qh5weubk7)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="113" x="706.5" y="53"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="99" x="713.5" y="72.9951">OpenidConnect</text><rect fill="#FEFECE" filter="url(#fa70qh5weubk7)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="113" x="706.5" y="840.75"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="99" x="713.5" y="860.7451">OpenidConnect</text><rect fill="#FEFECE" filter="url(#fa70qh5weubk7)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="137" x="993.5" y="53"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="123" x="1000.5" y="72.9951">Adgangsplatformen</text><rect fill="#FEFECE" filter="url(#fa70qh5weubk7)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;" width="137" x="993.5" y="840.75"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="123" x="1000.5" y="860.7451">Adgangsplatformen</text><rect fill="#FFFFFF" filter="url(#fa70qh5weubk7)" height="128.0977" style="stroke:#A80036;stroke-width:1.0;" width="10" x="214" y="247.5273"/><rect fill="#FFFFFF" filter="url(#fa70qh5weubk7)" height="87.3984" style="stroke:#A80036;stroke-width:1.0;" width="10" x="760" y="463.0234"/><polygon fill="#A80036" points="434,115.4297,444,119.4297,434,123.4297,438,119.4297" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="219" x2="440" y1="119.4297" y2="119.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="203" x="226" y="114.3638">Click login into Adgangsplatformen</text><polygon fill="#A80036" points="753,144.5625,763,148.5625,753,152.5625,757,148.5625" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="446" x2="759" y1="148.5625" y2="148.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="206" x="453" y="143.4966">Get authorization url and return url</text><line style="stroke:#A80036;stroke-width:1.0;" x1="765" x2="807" y1="177.6953" y2="177.6953"/><line style="stroke:#A80036;stroke-width:1.0;" x1="807" x2="807" y1="177.6953" y2="190.6953"/><line style="stroke:#A80036;stroke-width:1.0;" x1="766" x2="807" y1="190.6953" y2="190.6953"/><polygon fill="#A80036" points="776,186.6953,766,190.6953,776,194.6953,772,190.6953" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="223" x="772" y="172.6294">Gets urls and creates oauth state hash</text><polygon fill="#A80036" points="235,243.5273,225,247.5273,235,251.5273,231,247.5273" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="229" x2="764" y1="247.5273" y2="247.5273"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="251" x="241" y="242.4614">Tell browser to redirect to authorization url</text><path d="M5,203.6953 L5,273.6953 L205,273.6953 L205,213.6953 L195,203.6953 L5,203.6953 " fill="#FBFB77" filter="url(#fa70qh5weubk7)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M195,203.6953 L195,213.6953 L205,213.6953 L195,203.6953 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179" x="11" y="220.7622">The authorization url contains:</text><ellipse cx="16.5" cy="231.4609" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="53" x="22" y="235.895">returnurl</text><ellipse cx="16.5" cy="246.5938" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="60" x="22" y="251.0278">state hash</text><ellipse cx="16.5" cy="261.7266" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="55" x="22" y="266.1606">agency id</text><polygon fill="#A80036" points="1052,300.3594,1062,304.3594,1052,308.3594,1056,304.3594" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="224" x2="1058" y1="304.3594" y2="304.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="316" x="231" y="299.2935">Redirect to external site using the full authorization url</text><line style="stroke:#A80036;stroke-width:1.0;" x1="1064" x2="1106" y1="333.4922" y2="333.4922"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1106" x2="1106" y1="333.4922" y2="346.4922"/><line style="stroke:#A80036;stroke-width:1.0;" x1="1065" x2="1106" y1="346.4922" y2="346.4922"/><polygon fill="#A80036" points="1075,342.4922,1065,346.4922,1075,350.4922,1071,346.4922" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="1071" y="328.4263">Internal authentication</text><polygon fill="#A80036" points="230,371.625,220,375.625,230,379.625,226,375.625" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="224" x2="1063" y1="375.625" y2="375.625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144" x="236" y="370.5591">Redirect to the return url</text><polygon fill="#A80036" points="434,400.7578,444,404.7578,434,408.7578,438,404.7578" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="219" x2="440" y1="404.7578" y2="404.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="226" y="399.6919">Send Adgangsplatform reponse</text><polygon fill="#A80036" points="753,429.8906,763,433.8906,753,437.8906,757,433.8906" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="446" x2="759" y1="433.8906" y2="433.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="295" x="453" y="428.8247">Validate values from the Adgangsplatform reponse</text><polygon fill="#A80036" points="1052,459.0234,1062,463.0234,1052,467.0234,1056,463.0234" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="770" x2="1058" y1="463.0234" y2="463.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="125" x="777" y="457.9575">Request access token</text><polygon fill="#A80036" points="781,488.1563,771,492.1563,781,496.1563,777,492.1563" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="775" x2="1063" y1="492.1563" y2="492.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="270" x="787" y="487.0903">Returning access token with expire time stamp</text><polygon fill="#A80036" points="1052,517.2891,1062,521.2891,1052,525.2891,1056,521.2891" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="770" x2="1058" y1="521.2891" y2="521.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="777" y="516.2231">Requesting user info</text><polygon fill="#A80036" points="776,546.4219,766,550.4219,776,554.4219,772,550.4219" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="770" x2="1063" y1="550.4219" y2="550.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="782" y="545.356">Returning user info (UUID)</text><path d="M84,565.4219 L228,565.4219 L228,572.4219 L218,582.4219 L84,582.4219 L84,565.4219 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="101.6641" style="stroke:#000000;stroke-width:2.0;" width="749.5" x="84" y="565.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="96" x="99" y="578.4888">First time login</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="158" x="243" y="577.6323">[The user is not in Drupal yet]</text><polygon fill="#A80036" points="457,627.3867,447,631.3867,457,635.3867,453,631.3867" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="451" x2="764" y1="631.3867" y2="631.3867"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="67" x="463" y="626.3208">Create user</text><path d="M94,587.5547 L94,657.5547 L437,657.5547 L437,597.5547 L427,587.5547 L94,587.5547 " fill="#FBFB77" filter="url(#fa70qh5weubk7)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M427,587.5547 L427,597.5547 L437,597.5547 L427,587.5547 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><ellipse cx="105.5" cy="600.1875" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="264" x="111" y="604.6216">Random unique email/username set on user.</text><ellipse cx="105.5" cy="615.3203" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="281" x="111" y="619.7544">The UUID from Adgangsplatformen is encrypted</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="322" x="100" y="634.8872">and used for mapping external user to the Drupal user.</text><ellipse cx="105.5" cy="645.5859" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="260" x="111" y="650.02">The Drupal user gets the Drupal role: Patron.</text><path d="M224,681.0859 L371,681.0859 L371,688.0859 L361,698.0859 L224,698.0859 L224,681.0859 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="56.2656" style="stroke:#000000;stroke-width:2.0;" width="609.5" x="224" y="681.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="99" x="239" y="694.1528">Recurrent login</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="139" x="386" y="693.2964">[The user exists in Drupal]</text><polygon fill="#A80036" points="457,720.3516,447,724.3516,457,728.3516,453,724.3516" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="451" x2="764" y1="724.3516" y2="724.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="72" x="463" y="719.2856">Update user</text><path d="M234,703.2188 L234,728.2188 L437,728.2188 L437,713.2188 L427,703.2188 L234,703.2188 " fill="#FBFB77" filter="url(#fa70qh5weubk7)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M427,703.2188 L427,713.2188 L437,713.2188 L427,703.2188 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="182" x="240" y="720.2856">Nothing is updated on the user</text><polygon fill="#A80036" points="457,761.4844,447,765.4844,457,769.4844,453,765.4844" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="451" x2="764" y1="765.4844" y2="765.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="155" x="463" y="760.4185">Begin Drupal user session.</text><polygon fill="#A80036" points="457,790.6172,447,794.6172,457,798.6172,453,794.6172" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="451" x2="764" y1="794.6172" y2="794.6172"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="241" x="463" y="789.5513">Saving access token in active user session</text><polygon fill="#A80036" points="230,819.75,220,823.75,230,827.75,226,823.75" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="224" x2="764" y1="823.75" y2="823.75"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="247" x="236" y="818.6841">Redirecting inlogged user to the frontpage</text><!--MD5=[a8918474da1325b57ade3932e5d54c62]
@startuml
actor       User              as  user
participant DPL_CMS           as  cms
participant OpenidConnect    as  oc
participant Adgangsplatformen as  ap
user -> cms: Click login into Adgangsplatformen
cms -> oc: Get authorization url and return url
oc -> oc: Gets urls and creates oauth state hash

oc -> user: Tell browser to redirect to authorization url
activate user
note left
The authorization url contains:
* returnurl
* state hash
* agency id
end note
user -> ap: Redirect to external site using the full authorization url
ap -> ap: Internal authentication

ap -> user: Redirect to the return url
deactivate user
user -> cms: Send Adgangsplatform reponse
cms -> oc: Validate values from the Adgangsplatform reponse

oc -> ap: Request access token
activate oc
ap -> oc: Returning access token with expire time stamp
oc -> ap: Requesting user info
ap -> oc: Returning user info (UUID)
deactivate oc

group First time login [The user is not in Drupal yet]
oc -> cms: Create user
note left
* Random unique email/username set on user.
* The UUID from Adgangsplatformen is encrypted
and used for mapping external user to the Drupal user.
* The Drupal user gets the Drupal role: Patron.
end note
end
group Recurrent login [The user exists in Drupal]
oc -> cms: Update user
note left
Nothing is updated on the user
end note
end


oc -> cms: Begin Drupal user session.
oc -> cms: Saving access token in active user session
oc -> user: Redirecting inlogged user to the frontpage
@enduml

PlantUML version 1.2021.9(Sun Jul 25 10:13:56 GMT 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
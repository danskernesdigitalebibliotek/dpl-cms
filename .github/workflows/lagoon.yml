on:
  pull_request:
    types: [ opened, synchronize, reopened, closed ]
name: Lagoon integration

env:
  LAGOON_HOST: "dplplat01.dpl.reload.dk"
  LAGOON_PROJECT: "dpl-cms"

jobs:
  CheckEnvironment:
    name: Check environment
    runs-on: ubuntu-latest
    if: ${{ github.event.action == 'opened' || github.event.action == 'reopened' || github.event.action == 'synchronize' }}
    steps:
      - name: Generate environment data
        id: environment
        run: |
          echo ::set-output name=id::pr-${{github.event.number}}
          echo ::set-output name=url::'https://varnish.pr-${{github.event.number}}.${{ env.LAGOON_PROJECT }}.${{ env.LAGOON_HOST }}/'
          echo ::set-output name=logs::'https://ui.lagoon.${{ env.LAGOON_HOST }}/projects/${{ env.LAGOON_PROJECT }}/${{ env.LAGOON_PROJECT }}-pr-${{github.event.number}}/deployments'
      - name: Start deployment
        uses: bobheadxi/deployments@v0.6.1
        id: deployment
        with:
          step: start
          token: ${{ secrets.GITHUB_TOKEN }}
          env: ${{ steps.environment.outputs.id }}
          ref: ${{ github.head_ref }}
          logs: ${{ steps.environment.outputs.logs }}
          log_args: true
      - name: Wait for environment to become available
        uses: nev7n/wait_for_response@v1
        with:
          url: ${{ steps.environment.outputs.url }}
          responseCode: 200
          # Time in ms. Wait for 15 mins for deployment to complete. We have
          # seen deployments taking up to 12 mins.
          timeout: 600000
          # Poll every 10 seconds. For whatever reason Lagoon environments may
          # return 200 during the deployment process even though the deployment
          # is not complete. Reduce polling interval to the risk of this
          # happening.
          interval: 10000
      - name: Finish deployment
        if: always()
        uses: bobheadxi/deployments@v0.6.1
        with:
          step: finish
          token: ${{ secrets.GITHUB_TOKEN }}
          status: ${{ job.status }}
          deployment_id: ${{ steps.deployment.outputs.deployment_id }}
          env_url: ${{ steps.environment.outputs.url }}
          logs: ${{ steps.environment.outputs.logs }}
          log_args: true

  CloseEnvironment:
    name: Close environment
    runs-on: ubuntu-latest
    if: ${{ github.event.action == 'closed' }}
    steps:
      - name: Generate environment data
        id: environment
        run: |
          echo ::set-output name=id::pr-${{github.event.number}}
      - name: Close environment
        uses: bobheadxi/deployments@v0.6.1
        with:
          step: deactivate-env
          token: ${{ secrets.GITHUB_TOKEN }}
          env: ${{ steps.environment.outputs.id }}
          log_args: true

  InformLagoon:
    name: Send synthetic event to Lagoon
    runs-on: ubuntu-latest
    steps:
    - name: Forward event
      uses: distributhor/workflow-webhook@v2
      env:
        webhook_url: https://webhookhandler.lagoon.dplplat01.dpl.reload.dk
        webhook_secret: "ignored-secret"
        webhook_type: 'json-extended'
        verbose: true
